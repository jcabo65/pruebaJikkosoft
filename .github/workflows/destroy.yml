name: Destroy All

on:
  workflow_dispatch:
    inputs:
      prefix:
        description: "Prefijo de los stacks (Jikkosoft o Clouxter)"
        required: false
        default: "Jikkosoft"
      region:
        description: "AWS region"
        required: false
        default: "us-east-1"
      skip_iam:
        description: "Omitir borrado de IAM stack (si usas esas credenciales)"
        required: false
        default: "false"
      dry_run:
        description: "Dry run (no ejecuta, solo muestra comandos)"
        required: false
        default: "false"

jobs:
  destroy-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.region || 'us-east-1' }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Init vars
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="${{ github.event.inputs.prefix }}"
          REGION="${{ github.event.inputs.region }}"
          SKIP_IAM="${{ github.event.inputs.skip_iam }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          if [[ -z "${PREFIX}" ]]; then PREFIX="Jikkosoft"; fi
          if [[ -z "${REGION}" ]]; then REGION="us-east-1"; fi
          if [[ -z "${SKIP_IAM}" ]]; then SKIP_IAM="false"; fi
          if [[ -z "${DRY_RUN}" ]]; then DRY_RUN="false"; fi

          echo "STACK_PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "AWS_REGION=$REGION" >> $GITHUB_ENV
          echo "SKIP_IAM=$SKIP_IAM" >> $GITHUB_ENV
          echo "DRY_RUN=$DRY_RUN" >> $GITHUB_ENV

          echo "S_MON=${PREFIX}MonitoringStack" >> $GITHUB_ENV
          echo "S_EC2=${PREFIX}EC2Stack"        >> $GITHUB_ENV
          echo "S_IAM=${PREFIX}IAMStack"        >> $GITHUB_ENV
          echo "S_S3=${PREFIX}S3Stack"          >> $GITHUB_ENV
          echo "S_VPC=${PREFIX}VPCStack"        >> $GITHUB_ENV

          echo "Plan de destroy:"
          echo "  Region: $REGION"
          echo "  Prefix: $PREFIX"
          echo "  Orden:  ${PREFIX}MonitoringStack → ${PREFIX}EC2Stack → ${PREFIX}IAMStack → ${PREFIX}S3Stack → ${PREFIX}VPCStack"
          echo "  Skip IAM: $SKIP_IAM"
          echo "  Dry run:  $DRY_RUN"

      - name: Write helpers
        shell: bash
        run: |
          set -euo pipefail
          cat > helpers.sh << 'EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          aws_cmd() {
            if [[ "${DRY_RUN}" == "true" ]]; then
              echo "[DRY] aws $*"
            else
              aws "$@" --region "${AWS_REGION}"
            fi
          }

          stack_exists() {
            set +e
            aws cloudformation describe-stacks --stack-name "$1" --region "${AWS_REGION}" >/dev/null 2>&1
            local rc=$?
            set -e
            return $rc
          }

          delete_stack_if_exists() {
            local name="$1"
            if stack_exists "$name"; then
              echo "Deleting stack: $name"
              aws_cmd cloudformation delete-stack --stack-name "$name"
              if [[ "${DRY_RUN}" != "true" ]]; then
                aws cloudformation wait stack-delete-complete --stack-name "$name" --region "${AWS_REGION}" || {
                  echo "WARN: wait failed or stack already gone."
                }
              fi
              echo "Deleted: $name"
            else
              echo "Stack not found, skipping: $name"
            fi
          }

          bucket_from_stack() {
            local stack="$1"
            if stack_exists "$stack"; then
              aws cloudformation describe-stacks \
                --stack-name "$stack" \
                --region "${AWS_REGION}" \
                --query "Stacks[0].Outputs[?OutputKey=='BucketNameOut'].OutputValue" \
                --output text 2>/dev/null | grep -v '^None$' || echo ""
            else
              echo ""
            fi
          }

          empty_versioned_bucket() {
            local bucket="$1"
            if [[ -z "$bucket" || "$bucket" == "None" || "$bucket" == "null" ]]; then
              echo "No bucket to empty."
              return 0
            fi

            echo "Emptying versioned bucket: s3://$bucket"

            local is_truncated=true
            while [[ "$is_truncated" == "true" ]]; do
              local output
              output=$(aws s3api list-object-versions \
                --bucket "$bucket" \
                --region "${AWS_REGION}" \
                --max-items 1000 \
                --output json 2>/dev/null || echo '{"IsTruncated": false}')

              is_truncated=$(echo "$output" | jq -r '.IsTruncated')

              # Borrar versiones
              echo "$output" | jq -r '.Versions[]? | "\(.Key)\t\(.VersionId)"' | while IFS=$'\t' read -r key vid; do
                [[ -n "$key" && -n "$vid" ]] || continue
                aws_cmd s3api delete-object --bucket "$bucket" --key "$key" --version-id "$vid" || true
              done

              # Borrar delete markers
              echo "$output" | jq -r '.DeleteMarkers[]? | "\(.Key)\t\(.VersionId)"' | while IFS=$'\t' read -r key vid; do
                [[ -n "$key" && -n "$vid" ]] || continue
                aws_cmd s3api delete-object --bucket "$bucket" --key "$key" --version-id "$vid" || true
              done
            done

            echo "Bucket emptied: s3://$bucket"
          }

          print_stack_events() {
            local name="$1"
            if stack_exists "$name"; then
              echo "::group::Events for $name"
              aws cloudformation describe-stack-events --stack-name "$name" --region "${AWS_REGION}" \
                --query "reverse(StackEvents)[0:40].[Timestamp,LogicalResourceId,ResourceType,ResourceStatus,ResourceStatusReason]" \
                --output table || true
              echo "::endgroup::"
            fi
          }
          EOF
          chmod +x helpers.sh

      - name: Delete monitoring stack
        shell: bash
        run: |
          set -euo pipefail
          . ./helpers.sh
          print_stack_events "${S_MON}"
          delete_stack_if_exists "${S_MON}"

      - name: Delete EC2 stack
        shell: bash
        run: |
          set -euo pipefail
          . ./helpers.sh
          print_stack_events "${S_EC2}"
          delete_stack_if_exists "${S_EC2}"

      - name: Delete IAM stack
        if: env.SKIP_IAM != 'true'
        shell: bash
        run: |
          set -euo pipefail
          . ./helpers.sh
          print_stack_events "${S_IAM}"
          delete_stack_if_exists "${S_IAM}"

      - name: Empty S3 bucket and delete S3 stack
        shell: bash
        run: |
          set -euo pipefail
          . ./helpers.sh
          B="$(bucket_from_stack "${S_S3}" || echo "")"
          echo "Bucket from ${S_S3}: ${B:-<none>}"
          if [[ -n "${B:-}" && "${B}" != "None" && "${B}" != "null" ]]; then
            empty_versioned_bucket "$B"
          fi
          print_stack_events "${S_S3}"
          delete_stack_if_exists "${S_S3}"

      - name: Delete VPC stack
        shell: bash
        run: |
          set -euo pipefail
          . ./helpers.sh
          print_stack_events "${S_VPC}"
          delete_stack_if_exists "${S_VPC}"

      - name: Done
        run: echo "Destroy complete"
